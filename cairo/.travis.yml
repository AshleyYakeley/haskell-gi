dist: bionic
language: c

cache:
  directories:
    - $HOME/.cabal/packages
    - $HOME/.cabal/store

before_cache:
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/build-reports.log
  # remove files that are regenerated by 'cabal update'
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/00-index.*
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/*.json
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/01-index.cache
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/01-index.tar
  - rm -fv $HOME/.cabal/packages/hackage.haskell.org/01-index.tar.idx

before_install:
  - unset CC
  - sudo add-apt-repository ppa:hvr/ghc -y
  - sudo apt-get update -q
  - sudo apt-get install libsdl2-dev libgirepository1.0-dev libgtk-3-dev libcairo2-dev libcairo-gobject2 -y
  - sudo apt-get install cabal-install-3.4 ghc-8.10.2 happy-1.19.5 alex-3.1.7 -y
  - export PATH="$HOME/.cabal/bin:/opt/ghc/bin:/opt/cabal/bin:$PATH"
  - curl -L https://nixos.org/nix/install | sh

install:
  - cabal --version
  - echo "$(ghc --version) [$(ghc --print-project-git-commit-id 2> /dev/null || echo '?')]"
  - travis_retry cabal v2-update

before_script:
  - source /home/travis/.nix-profile/etc/profile.d/nix.sh

script:
  - cabal v2-build all
  - cabal v2-test all
  - cabal v2-haddock all
  - nix-build release.nix
